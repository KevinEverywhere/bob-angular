"use strict";angular.module("bobApp.svg",["bobApp","threeModule","ngRoute","ui.router"]).controller("ThreeSVGController",["$window","$scope","$rootScope","$state","$stateParams","LocalCRUDService","threeCSSService","countryService",function($window,$scope,$rootScope,$state,$stateParams,LocalCRUDService,threeCSSService,countryService){$scope.name="ThreeSVGController",$scope._position={z:-70},$scope._rotation={x:0,y:threeCSSService.radianCalculator(200),z:threeCSSService.radianCalculator(180)},$scope.threeCSSService=threeCSSService,$scope.currentItem=null,$scope.activeAnimations=["animate"],$scope.activeParams={},$scope.d3World={},$scope._dir=-1,$scope.incr=.008,$scope.initialScale=.4,$scope.currentRotate=180,$scope.maxRotate=190,$scope.minRotate=170,$scope.svgDiv=function(){return document.getElementById($scope._svgDiv)},$scope.initWorld=function(){var me=this;$scope.svgDiv().addEventListener("touchend",function(evt){me.svgCall(evt)},!1),$scope.svgDiv().addEventListener("click",function(evt){me.svgCall(evt)},!1)},$scope.svgCall=function(evt){null!=$scope.currentItem&&d3.select("#"+$scope.currentItem).attr("opacity",1),$scope.currentItem=evt.target.parentNode.id,d3.select("#"+evt.target.parentNode.id).attr("opacity",0)},$scope.loadSVG=function(xml){try{$scope.importedNode=document.importNode(xml.documentElement,!0),$window.d3.select("#"+$scope._svgDiv).node().appendChild($scope.importedNode),$scope.threeCSSService.init($scope.elem,$scope,$scope.__content,$scope._context),render()}catch(oops){}},$scope.csvCall=function(){var _csv="assets/media/cpi.csv",rtn=d3.csv(_csv).row(function(d){var theYear=+d.Year;return 2010==theYear?{name:d["Country Name"],year:theYear,code:d["Country Code"],cpi:Math.floor(d.CPI)}:void 0}).get(function(error,rows){return rows});return rtn},$scope.init=function(elem,_content,_svgDiv,_context,svgURL){$rootScope._context=$("#"+_context).html();var me=$scope;$scope.elem=elem,$scope.__content=_content,$scope._context=_context,$scope._svgDiv=_svgDiv,$scope.svgURL=svgURL,$scope.d3World=d3.xml($scope.svgURL,"image/svg+xml",function(xml){console.log("xml="+xml),$window._xml=xml,me.loadSVG(xml),me.initWorld(),countryService.init(),me.paintOrder(me.csvCall()),console.log('countryService.get3From2("CAn")='+countryService.get2From3("CAn"))})},$scope.paintOrder=function(arr,_colorArray){for(var colorArray=_colorArray?_colorArray:["000","2b2b2b","555","777","999","BBB","DDD","FFF"],counter=0,a=0;a<arr.length;a++)try{console.log("arr.length="+arr.length),d3.select("#"+countryService.get2From3(arr[a].code).toLowerCase()),counter++,console.log(counter+" ok "+colorArray[Math.floor(a*colorArray.length/arr.length)])}catch(oops){console.log(counter+" FAILED  "+arr[a])}},$scope.animate=function(){$scope.currentRotate+=$scope._dir*$scope.incr,$scope.currentRotate<$scope.maxRotate?$scope.currentRotate<$scope.minRotate&&($scope._dir=-$scope._dir,$scope.currentRotate+=$scope._dir):($scope._dir=-$scope._dir,$scope.currentRotate+=$scope._dir),$scope.css3DObject.rotation.y=threeCSSService.radianCalculator($scope.currentRotate),$scope.css3DObject.position.z=$scope.css3DObject.position.z+$scope._dir*$scope.incr*10,$scope.renderer.render($scope.scene,$scope.camera)};var render=function(){$scope.renderer.render($scope.scene,$scope.camera),threeCSSService.render($scope)}}]).directive("threeSVG",function(){var threeObj={restrict:"AE",replace:!1,scope:{id:"@",eventHandler:"&ngClick"},template:"<div id='svgDiv' data-ng-click='mapClick(this)'></div>"};return threeObj});