"use strict";var d3Module=angular.module("d3Module",[]).service("D3Service",["$window","$rootScope","$http","$q","$state","MapService","LocalCRUDService",function($window,$rootScope,$http,$q,$state,MapService,LocalCRUDService){var service={_width:-1,_height:-1,contentArray:[],currentContent:-1,currentCountry:null,currentCountryObj:null,currentScale:-1,svgClicked:!1,svgCallTimer:null,svgCallTimeoutLength:250,selectedColor:"#C00",defaultColor:"#FFF",defaultSVGWidth:1080,defaultSVGHeight:460,records:[],initialScale:.4,jsonURL:"assets/js/world.json",jsonOBJ:null,svgURL:"assets/media/groupedWorld.svg",d3Data:null,inited:!1,initSVG:function(_width,_height,targetContainer,contentAddress){this._width=_width,this._height=_height,this.targetContainer=targetContainer,this.contentAddress=contentAddress,this.initMyContent(),this.loadSVG(this.getCurrent())},createCountryObject:function(obj,svg,whichEl){var _this=this,countryObject={selectedTimes:0,visitedTimes:0,parent:_this,countryImg:svg,targetImg:whichEl,incrSelected:function(){this.selectedTimes++},_name:function(){return this.CountryName.replace("+"," ")},updateSelectShading:function(){var o=Math.max(.2,1-this.selectedTimes/10);$(this.countryImg).attr("opacity",o)},incrementCount:function(){this.visitedTimes++},getColor:function(){var _color=null;try{_color=$(this.countryImg).selectAll("g").selectAll("path").attr("fill")}catch(oops){console.log("getColor oops="+oops)}return _color},setColor:function(_color,_opacity){try{$(this.countryImg).selectAll("g").selectAll("path").attr("fill",_color),this.colorChildAreas(_color,_opacity)}catch(oops){console.log("setColor oops="+oops)}if(_opacity)try{$(this.countryImg).attr("opacity",_opacity)}catch(oops){}},colorChildAreas:function(_color){try{$(this.countryImg).selectAll("use").filter(function(){$(this.href.baseVal).selectAll("g").select("path").attr("fill",_color)})}catch(oops){console.log("colorChildareas oops="+oops)}}};for(var z in countryObject)obj[z]=countryObject[z]},initCountries:function(){for(var z in this.d3Data.world.countries){var dd=this.d3Data.world.countries[z].GeoObject;try{var bv=d3.selectAll("use").filter(function(){return this.href.baseVal=="#"+dd})[0][0];this.createCountryObject(this.d3Data.world.countries[z],bv.href.baseVal,d3.select("#"+dd))}catch(oops){}}},incrementContent:function(){this.currentContent=Math.floor(Math.min(this.currentContent+1,this.contentArray.length-.6))},loadSVGXML:function(_xml){$rootScope.$broadcast("enoughLoaded");var xml;xml=null==_xml?LocalCRUDService.manageLocalCRUD("retrieve","svgWorld","stringToXML"):_xml;try{this.importedNode=document.importNode(xml.documentElement,!0),d3.select("#"+this.targetContainer).node().appendChild(this.importedNode),this.initWorld(!0),this.initCountries()}catch(oops){try{var _xml=LocalCRUDService.manageLocalCRUD("retrieve","svgWorld","stringToXML");xml=$.parseXML(_xml),this.importedNode=document.importNode(xml.documentElement,!0),d3.select("#"+this.targetContainer).node().appendChild(this.importedNode),this.initWorld(!0),this.initCountries()}catch(oops){console.log("Load SVG no noBueno Try-Catch")}}},loadSVG:function(){$rootScope.$broadcast("svgLoaded");var me=this;if(0===document.getElementsByTagName("svg").length){var _LocalCRUDService=LocalCRUDService;LocalCRUDService.manageLocalCRUD("retrieve","svgWorld")?this.loadSVGXML(null):this.d3World=d3.xml(this.getCurrent(),"image/svg+xml",function(xml){console.log("xml="+xml),_LocalCRUDService.manageLocalCRUD("create",{key:"svgWorld",value:xml},"xmlToString"),me.loadSVGXML(xml)})}else me.initWorld(),me.initCountries()},initWorld:function(init){var me=this;document.getElementById("theWorld").addEventListener("touchend",function(evt){me.svgCall(evt)},!1),document.getElementById("theWorld").addEventListener("click",function(evt){me.svgCall(evt)},!1),init&&this.testScaling()},getTContainer:function(){return document.getElementById(this.targetContainer)},testScaling:function(){var _w=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,_h=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,h=(Math.max(_w,_h),Math.min(_w,_h)),actualWorld={width:1060,height:480};this.currentScale=h/actualWorld.width,this.scaleWorld(this.currentScale<0?this.initialScale:this.currentScale)},increaseScaleWorld:function(evt){var y=evt;for(var z in y);this.scaleWorld(1.5*this.currentScale,{x:evt.clientX,y:evt.clientY})},scaleWorld:function(toWhatArg,offsetObj){var toWhat=this.currentScale=Math.max(Math.min(toWhatArg,4),0),_this=this.getTContainer().getBoundingClientRect(),xMult=offsetObj?offsetObj.x:1,yMult=offsetObj?offsetObj.y:1;this.getTContainer().style.left=(1!=xMult?-(toWhat*xMult-_this.x)/2:0)-(this._width-toWhat*this._width)/2+"px",this.getTContainer().style.top=(1!=yMult?-(toWhat*yMult-_this.y)/2:0)-(this._height-toWhat*this._height)/2+"px",this.getTContainer().style.opacity=1,this.addTransform("scale","scale("+toWhat+", "+toWhat+")"),this.updateTransforms()},_transforms:{},addTransform:function(whatTransform,whatValue){this._transforms[whatTransform]=whatValue},updateTransforms:function(){var sp="";for(var z in this._transforms)sp+=this._transforms[z]+" ";try{document.getElementById("worldDiv").style.webkitTransform=sp,document.getElementById("worldDiv").style.MozTransform=sp,document.getElementById("worldDiv").style.transform=sp}catch(oops){try{document.getElementById("worldDiv").style.MozTransform=sp,document.getElementById("worldDiv").style.transform=sp}catch(oops){document.getElementById("worldDiv").style.transform=sp,consoloe.log(xp+" failed")}}},setCountryVal:function(whichCountry,whichProp,whichVal){this.getCountry(whichCountry)[whichProp]=whichVal},setMyContent:function(whichEl,whichProp,whichVal){d3.select(whichEl).attr(whichProp,whichVal)},getCountry:function(whichCountry){var zz=null;for(var z in this.d3Data.world.countries)try{if(-1!=whichCountry.indexOf(this.d3Data.world.countries[z].GeoObject)){zz=this.d3Data.world.countries[z];break}}catch(oops){}if(null==zz)for(var z in this.d3Data.world.countries)try{if(-1!=whichCountry.indexOf(this.d3Data.world.countries[z].CountryName)||-1!=whichCountry.indexOf(this.d3Data.world.countries[z]._name())){zz=this.d3Data.world.countries[z];break}}catch(oops){}if(null==zz)switch(whichCountry.toLowerCase()){case"congo democratic republic of the":zz=this.getCountry("democraticRepublicOfCongo");break;case"congo republic of the":zz=this.getCountry("republicOfCongo");break;case"cote d'ivoire":zz=this.getCountry("coteDIvoire");break;case"serbia and montenegro":zz=this.getCountry("serbia");break;case"bosnia and herzegovina":zz=this.getCountry("bosnia");break;case"central african republic":zz=this.getCountry("centralAfricanRepublic");break;case"nigeria":zz=this.getCountry("nigeria");break;case"romania":zz=this.getCountry("romania");break;case"somalia":zz=this.getCountry("somalia");break;case"usa":zz=this.getCountry("unitedStates")}return zz},swapHighlights:function(whichCountry){this.bindCountryObject(this.getCountry(whichCountry))},highlightCountry:function(whichCountry){console.log("highlightCountry:function("+whichCountry),d3.select(0==whichCountry.indexOf("#")?whichCountry:"#"+whichCountry).attr("opacity",.1)},unhighlightCountry:function(whichCountry){console.log("UN HLCountry:function("+whichCountry),d3.select(0==whichCountry.indexOf("#")?whichCountry:"#"+whichCountry).attr("opacity",1)},setCountry:function(whichCountry,whichEl){if(console.log("whichCountry.TS="+whichCountry.toString()+";whichEl="+whichEl),null==this.currentCountryObj||whichCountry!=this.currentCountryObj.countryImg){var theID=$(whichCountry).attr("id")?$(whichCountry).attr("id"):whichCountry.context?whichCountry.context.href.baseVal:null;if(null!=theID){MapService.userActivated=!0;try{console.log("theID="+theID),null!=this.getCountry(theID)&&this.currentCountryObj!=this.getCountry(theID)&&null!=this.currentCountryObj&&(console.log("this.currentCountryObj"),this.currentCountryObj.updateSelectShading()),this.bindCountryObject(this.getCountry(theID),"incrSelected",whichCountry,whichEl),MapService.getCountryData(this.currentCountryObj.CountryID-1),$rootScope.$broadcast("countrySelected",{Country:this.currentCountryObj})}catch(oops){console.log("noBueno")}}}},bindCountryObject:function(obj,func,svg,whichEl){this.currentCountryObj&&this.unhighlightCountry(this.currentCountryObj.GeoObject),func?(obj.selectedTimes||this.createCountryObject(obj,svg,whichEl),this.currentCountryObj=obj,obj[func]()):this.currentCountryObj=obj,this.highlightCountry(this.currentCountryObj.GeoObject)},svgCallClickThrough:function(evt){console.log("through.svgCallClickThrough="+evt.target+"svgCall="+evt);evt.target;this._target=evt;try{if(evt.target&&evt.target.correspondingUseElement)console.log("correspondingUseElement"),this.setCountry($(evt.target.correspondingUseElement),evt.target);else if(evt.target.href){console.log("basedval2");var _target=d3.selectAll("symbol").filter(function(){return-1!=evt.target.href.baseVal.indexOf(this.id)});this.setCountry($(evt.target),_target),console.log("basedval3")}}catch(oops){console.log("uh oh")}this.svgClicked=!1},svgCallDoubleClick:function(evt){console.log("svgCallDoubleClick="+evt.target+"svgCall="+evt),this.increaseScaleWorld(evt),this.svgClicked=!1},svgCall:function(evt){var me=this,_evt=evt;1==this.svgClicked?(this.svgCallDoubleClick(evt),$window.clearTimeout(this.svgCallTimer)):(this.svgClicked=!0,this.svgCallTimer=$window.setTimeout(function(){me.svgCallClickThrough(_evt)},this.svgCallTimeoutLength))},getCurrent:function(){return this.contentArray[this.currentContent]},initMyContent:function(){"string"==typeof this.contentAddress.toLowerCase()?this.contentArray.push(this.contentAddress):this.contentArray=this.contentAddress,this.incrementContent()},init:function(){var me=this;this.inited?($rootScope.countries=me.d3Data.world.countries,me.initSVG(me.defaultSVGWidth,me.defaultSVGHeight,"worldDiv",me.svgURL)):(d3.json(this.jsonURL,function(err,d){err?console.log("ERR("+err):(me.d3Data=d,$rootScope.countries=me.d3Data.world.countries,me.initSVG(me.defaultSVGWidth,me.defaultSVGHeight,"worldDiv",me.svgURL))}),this.inited=!0)}};return $rootScope.swapHighlights=service.swapHighlights,service}]);